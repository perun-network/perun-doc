

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Perun-node &mdash; perun-doc master documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Concepts" href="../concepts/state-channel.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          


          
            <a href="../index.html" class="icon icon-home"> perun-doc
          

          
          </a>

          
            
            
              <div class="version">
                master
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          

<!-- TODO : Include project logo, github repo link, community chat link -->

        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/state-channel.html">Concepts</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Perun-node</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#functionalities">Functionalities</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#off-chain-identity-management">Off-Chain Identity Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="#key-management">Key Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="#session">Session</a></li>
<li class="toctree-l4"><a class="reference internal" href="#user-api">User API</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#perun-node-cli">Perun-node cli</a></li>
<li class="toctree-l2"><a class="reference internal" href="#releases">Releases</a></li>
<li class="toctree-l2"><a class="reference internal" href="#user-guide">User guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#deployment-environment">Deployment environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pre-requisites">Pre-requisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="#getting-started">Getting started</a></li>
<li class="toctree-l3"><a class="reference internal" href="#initializing-the-perun-node">Initializing the perun-node</a></li>
<li class="toctree-l3"><a class="reference internal" href="#optional-connecting-to-ropsten-testnet">(Optional) Connecting to ropsten testnet</a></li>
<li class="toctree-l3"><a class="reference internal" href="#initializing-perunnode-cli">Initializing perunnode-cli</a></li>
<li class="toctree-l3"><a class="reference internal" href="#opening-a-session-opening-channel-within-it-making-payments-closing-it">Opening a session, opening channel within it, making payments &amp; closing it</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">perun-doc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Perun-node</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/hyperledger-labs/perun-doc/blob/master/source/node/introduction.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="perun-node">
<h1>Perun-node<a class="headerlink" href="#perun-node" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<span id="node-intro"></span><h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Perun-node is a multi-user node software intended to provide users to open,
transact on and settle state channels. It is implemented in golang and
currently supports payment channels on ethereum. Running an instance of
perun-node will start also start an API server, that serves APIs for the user
to interact with the node.</p>
<p>It uses the go-perun SDK for running the perun protocol and implements the
following functionalities on top of that.</p>
<div class="section" id="functionalities">
<h3>Functionalities<a class="headerlink" href="#functionalities" title="Permalink to this headline">¶</a></h3>
<div class="section" id="off-chain-identity-management">
<h4>Off-Chain Identity Management<a class="headerlink" href="#off-chain-identity-management" title="Permalink to this headline">¶</a></h4>
<p>Enable the user to identify participants in the off-chain network by using an
Identity provider service. Currently, we have implemented a local identity
provider by storing a list of known participants and their identities in a file
on the disk. The user can aliases to reference the identities of off-chain
participants.</p>
</div>
<div class="section" id="key-management">
<h4>Key Management<a class="headerlink" href="#key-management" title="Permalink to this headline">¶</a></h4>
<p>Enable the user to manage his cryptographic keys used for signing on-chain
transactions and off-chain messages. Currently we have implemented support for
ethereum keystore.</p>
</div>
<div class="section" id="session">
<h4>Session<a class="headerlink" href="#session" title="Permalink to this headline">¶</a></h4>
<p>Provide an environment for the user access his ID provider, key manager and
manage all the channels, throughout their lifecycle. In the context of a
session, he/she can open a state channel, do some transactions through channels
and settle the channel. Each session runs its own instance of state channel
network client, ID provider, key manager; and hence provides a complete
isolated environment within the node. It is this feature that enables multiple
users to use the same node by having dedicated sessions for each of them.</p>
<p>User need not be worried about losing his/her data when a sudden closure of
session occurs due to some network error or because of some other reasons.  All
the data within the sessions are continuously persisted. User can reopen the
session at any time. User can close the session according to his/her needs.</p>
</div>
<div class="section" id="user-api">
<h4>User API<a class="headerlink" href="#user-api" title="Permalink to this headline">¶</a></h4>
<p>Provide an interface for the user to interact with the node. The UserAPI
consists of three category of methods: Node, Session and Channel to access the
respective functionalities. Currently, we implement two party payment channel
API for ethereum blockchain using gRPC protocol. It can be used for opening a
payment channel where they can send or receive payments and finalize and settle
the channel on the blockchain.</p>
<p>Starting the perun-node will a run a grpc server and client for communication.
Each API used in the system and it’s specifications is available at the below
link.</p>
<p>Link to API specification: <a class="reference external" href="https://github.com/hyperledger-labs/perun-proposals/blob/master/design/001-RPC-Interface-Specification.md">https://github.com/hyperledger-labs/perun-proposals/blob/master/design/001-RPC-Interface-Specification.md</a></p>
</div>
</div>
</div>
<div class="section" id="perun-node-cli">
<h2>Perun-node cli<a class="headerlink" href="#perun-node-cli" title="Permalink to this headline">¶</a></h2>
<p>Perun-nodecli is a single user software with an interactive CLI interface to
connect with and use a running instance of perun-node. It is an independent
module that uses gRPC client stubs generated from the API specification to
interact with perun-node and does not share any code with other components of
the project. It provides different set of commands such as <cite>chain</cite>, <cite>node</cite>,
<cite>session</cite>, <cite>peer-id</cite>, <cite>channel</cite> and <cite>payment</cite>. See the <a class="reference internal" href="#user-guide"><span class="std std-ref">User guide</span></a> for
information on how to use these commands.</p>
<p>For steps to build the perun-node and tryout perun-node cli, see the next page.</p>
</div>
<div class="section" id="releases">
<h2>Releases<a class="headerlink" href="#releases" title="Permalink to this headline">¶</a></h2>
<p>Current version is
<a class="reference external" href="https://github.com/hyperledger-labs/perun-node/releases/tag/v0.5.0">v0.5.0</a>.</p>
<p>We have made 5 development releases so far. Of these <a class="reference external" href="https://github.com/hyperledger-labs/perun-node/releases/tag/v0.1.0">v0.1.0</a> &amp;
<a class="reference external" href="https://github.com/hyperledger-labs/perun-node/releases/tag/v0.2.0">v0.2.0</a> are
legacy versions, developed under the project name ‘dst-go’, source code of
which can be found in <a class="reference external" href="https://github.com/hyperledger-labs/perun-node/tree/legacy/master">legacy/master</a> of
perun-node repo.</p>
<p>Details on the new features and improvements included in each release can be
found in the <a class="reference external" href="https://github.com/hyperledger-labs/perun-node/releases">releases
section</a> of
perun-node repository.</p>
</div>
<div class="section" id="user-guide">
<h2>User guide<a class="headerlink" href="#user-guide" title="Permalink to this headline">¶</a></h2>
<div class="section" id="deployment-environment">
<h3>Deployment environment<a class="headerlink" href="#deployment-environment" title="Permalink to this headline">¶</a></h3>
<p>The below diagram shows the environment in which perun-node will be deployed.</p>
<img alt="Image not available" class="align-center" src="../_images/deployment_diagram.svg" /><p>In a test environment, the artifacts for setting up a contacts provider and
wallet provider can be generated using the perun-node software itself. But it
is upto the user to set up a blockchain node. Recommended way for trying out is
to use a ganache-cli node.</p>
</div>
<div class="section" id="pre-requisites">
<h3>Pre-requisites<a class="headerlink" href="#pre-requisites" title="Permalink to this headline">¶</a></h3>
<p>To use the perun-node, the following pre-requisites need to be met.</p>
<ol class="arabic simple">
<li><p>Linux operating system</p></li>
<li><p>Go (v1.14 or later)</p></li>
<li><ol class="loweralpha simple">
<li><p>A running instance of ganache-cli (v6.9.1 or later) or</p></li>
<li><p>A local blockchain network started using geth node or</p></li>
<li><p>A connection to the ropsten testnet.</p></li>
</ol>
</li>
</ol>
<p>Note: If using ropsten testnet, user should have keys corresponding to accounts
funded on the testnet and needs to follow additional steps when generating
configuration artifacts.</p>
</div>
<div class="section" id="getting-started">
<h3>Getting started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Start a blockchain network using ganache-cli node using the below command,
The two accounts in the command correspond to accounts that will be used in
default configuration artifacts that will be generated in a later steps.
Both these accounts are funded with 10 ETH each.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ganache</span><span class="o">-</span><span class="n">cli</span> <span class="o">-</span><span class="n">b</span> <span class="mi">1</span> <span class="o">--</span><span class="n">account</span><span class="o">=</span><span class="s2">&quot;0x1fedd636dbc7e8d41a0622a2040b86fea8842cef9d4aa4c582aad00465b7acff,100000000000000000000&quot;</span> <span class="o">--</span><span class="n">account</span><span class="o">=</span><span class="s2">&quot;0xb0309c60b4622d3071fad3e16c2ce4d0b1e7758316c187754f4dd0cfb44ceb33,100000000000000000000&quot;</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Open a terminal, go to the location where the perun-node project should get
reside, clone the project repository and switch into directory using the
below command.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">hyperledger</span><span class="o">-</span><span class="n">labs</span><span class="o">/</span><span class="n">perun</span><span class="o">-</span><span class="n">node</span><span class="o">.</span><span class="n">git</span> <span class="o">&amp;&amp;</span> <span class="n">cd</span> <span class="n">perun</span><span class="o">-</span><span class="n">node</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Run the tests using the below command.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">go</span> <span class="n">tests</span> <span class="o">-</span><span class="n">tags</span><span class="o">=</span><span class="n">integration</span> <span class="o">-</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span><span class="n">p</span> <span class="mi">1</span> <span class="o">./...</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Build the project using the below command. This will generate two binaries:
<cite>perunnode</cite> and <cite>perunnode-cli</cite>.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">perun</span><span class="o">-</span><span class="n">node</span> <span class="o">&amp;&amp;</span> <span class="n">make</span>
</pre></div>
</div>
</div>
<div class="section" id="initializing-the-perun-node">
<h3>Initializing the perun-node<a class="headerlink" href="#initializing-the-perun-node" title="Permalink to this headline">¶</a></h3>
<p>To start a perun-node, user needs an ID provider, wallet provider, blockchain
node and a configuration file as show in the below diagram. The order in which
the artifacts have to be set up is show in the below diagram.</p>
<img alt="Image not available" class="align-center" src="../_images/act_node_init.svg" /><p>1. The blockchain node was setup in step 4 of the <a class="reference internal" href="#getting-started"><span class="std std-ref">Getting started</span></a>. Run the
below command to generate the remaining artifacts.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">perunnode</span> <span class="n">generate</span>
</pre></div>
</div>
<p>This will generate the following artifacts:</p>
<ul class="simple">
<li><p>Node: node.yaml file.</p></li>
<li><p>Session: Two directories (alice and bob) each containing <cite>session.yaml</cite> file,
<cite>idprovider.yaml</cite> file and <cite>keystore</cite> directory with keys corresponding to
the on-chain and off-chain accounts.</p></li>
</ul>
<p>When using ganache-cli node with command mentioned in <a class="reference internal" href="#getting-started"><span class="std std-ref">Getting started</span></a>,
these files can be used as such. The contracts addresses are pre-computed based
on the account address and will be deployed on the ganache-cli node in a later
step.</p>
<p>When using ropsten testnet, follow the steps mentioned in this
<a class="reference internal" href="#optional-connecting-to-ropsten-testnet"><span class="std std-ref">(Optional) Connecting to ropsten testnet</span></a> section before proceeding
further.</p>
<ol class="arabic simple" start="2">
<li><p>Run the below command to start the perun-node.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">perunnode</span> <span class="n">run</span>
</pre></div>
</div>
<p>This will start the perunnode using the config file located at default path
<cite>./node.yaml</cite> that was generated in step 3. You will see a line “Serving
payment channel API via grpc at port :50001” with a blinking cursor.  Leave
this running in this terminal.</p>
</div>
<div class="section" id="optional-connecting-to-ropsten-testnet">
<h3>(Optional) Connecting to ropsten testnet<a class="headerlink" href="#optional-connecting-to-ropsten-testnet" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Start an instance of geth node or use an external service to connect with
rospten testnet. In all case, update the URL (using websockets protocol) in
the configuration files <cite>node.yaml</cite>, <cite>alice/session.yaml</cite> and
<cite>bob/session.yaml</cite>.</p></li>
<li><p>The contracts for perun-node v0.5.0 are deployed on the testnet in the
following addresses: adjudicator
(0x7dd2c7d72aAADaE2467b429920d2df88798CCda4) and ETH asset holder
(0x30241b890b0c1A2d9B6Ce3D172020647C94E2AFa). Updated these address in all
three config files.</p></li>
<li><p>Create two accounts and fund them with a few ethers by requesting from
faucet one for alice and one for bob. Update the keys and address of the
created accounts in the session config files.</p></li>
</ol>
</div>
<div class="section" id="initializing-perunnode-cli">
<h3>Initializing perunnode-cli<a class="headerlink" href="#initializing-perunnode-cli" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Open two new terminals side by side, one each for alice and bob roles
respectively. In both the terminal, start the perunnode-cli app using below
command:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">perunnodecli</span>
</pre></div>
</div>
<p>This will bring up an interactive shell with auto-completion support. Type
<cite>help</cite> to see a list of commands and their help message. Typing one of those
commands without any arguments will print the help message for that command,
including the list of sub-commands. All commands and sub-commands support
autocompletion.</p>
<ol class="arabic simple" start="2">
<li><p>Set the blockchain address. This address will be used by the sub-commands of
chain command. Which are not a part of perun-node API, but are helper
commands to directly interact with blockchain to deploy contracts and read
on-chain balances.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chain</span> <span class="nb">set</span><span class="o">-</span><span class="n">blockchain</span><span class="o">-</span><span class="n">address</span> <span class="n">ws</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8545</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>(Optional step, required only when using ganache-cli node) In any one of the
terminals, deploy perun contracts using the below commands. Just a reminder
for one last time, you can almost get every value by using auto-completion
(by pressing TAB) and get away without typing.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chain</span> <span class="n">deploy</span><span class="o">-</span><span class="n">perun</span><span class="o">-</span><span class="n">contracts</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Read the on-chain balance using the below commands. The addresses for
default configuration are available as autocomplete suggestion, if some
other address was used, it needs to be entered manually.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chain</span> <span class="n">get</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">chain</span><span class="o">-</span><span class="n">balance</span> <span class="mh">0x8450c0055cB180C7C37A25866132A740b812937B</span>

<span class="n">chain</span> <span class="n">get</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">chain</span><span class="o">-</span><span class="n">balance</span> <span class="mh">0xc4bA4815c82727554e4c12A07a139b74c6742322</span>
</pre></div>
</div>
<p>You can use these commands at any time before opening, while open or after
closing a payment channel.</p>
</div>
<div class="section" id="opening-a-session-opening-channel-within-it-making-payments-closing-it">
<h3>Opening a session, opening channel within it, making payments &amp; closing it<a class="headerlink" href="#opening-a-session-opening-channel-within-it-making-payments-closing-it" title="Permalink to this headline">¶</a></h3>
<p>From here on, choose one terminal for alice role and one for bob role. In each
step, the role will be the enclosed in square brackets before description.</p>
<ol class="arabic">
<li><p>Opening a session and reading peer ID.</p>
<p>a. [Alice] Start the session and get the peer ID of bob to check if it is
present. Getting the peer ID will also add the peer alias to auto-completion
list. The alias will then suggested, wherever a peer alias is expected. Two
exceptions where peer alias is not auto-completed are <cite>peer-id add</cite> and
<cite>peer-id get</cite> commands, because these commands are designed to add/get peer
IDs for unknown aliases.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># [Alice]</span>
<span class="n">node</span> <span class="n">connect</span> <span class="p">:</span><span class="mi">50001</span>
<span class="n">session</span> <span class="nb">open</span> <span class="n">alice</span><span class="o">/</span><span class="n">session</span><span class="o">.</span><span class="n">yaml</span>
<span class="n">peer</span><span class="o">-</span><span class="nb">id</span> <span class="n">get</span> <span class="n">bob</span>
</pre></div>
</div>
<ol class="loweralpha simple" start="2">
<li><p>[Bob] Repeat step 3 for bob using below commands:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># [Bob]</span>
<span class="n">node</span> <span class="n">connect</span> <span class="p">:</span><span class="mi">50001</span>
<span class="n">session</span> <span class="nb">open</span> <span class="n">bob</span><span class="o">/</span><span class="n">session</span><span class="o">.</span><span class="n">yaml</span>
<span class="n">peer</span><span class="o">-</span><span class="nb">id</span> <span class="n">get</span> <span class="n">alice</span>
</pre></div>
</div>
</li>
</ol>
<ol class="arabic" start="4">
<li><p>Sending a request to open a payment channel and accepting it.</p>
<ol class="loweralpha simple">
<li><p>[Alice] Send a request to open a channel with bob:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># [Alice]</span>
<span class="n">channel</span> <span class="n">send</span><span class="o">-</span><span class="n">opening</span><span class="o">-</span><span class="n">request</span> <span class="n">bob</span> <span class="mi">1</span> <span class="mi">2</span>
</pre></div>
</div>
<p>b. [Bob] Receives a channel opening request notification that includes
request ID. Type the command to accept the channel opening request directly
after receiving the notification:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># [Bob]</span>
<span class="n">channel</span> <span class="n">accept</span><span class="o">-</span><span class="n">opening</span><span class="o">-</span><span class="n">request</span> <span class="n">request_1_alice</span>
</pre></div>
</div>
</li>
</ol>
<p>Once successfully accepted, information on the opened channel is printed in
both terminals.</p>
<ol class="arabic simple" start="5">
<li><p>Listing out open channels. In any of the terminals, type the below command
to see the list of open channels:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">channel</span> <span class="nb">list</span><span class="o">-</span><span class="nb">open</span><span class="o">-</span><span class="n">channels</span>
</pre></div>
</div>
<ol class="arabic" start="6">
<li><p>Sending a request to open a payment channel and rejecting it.</p>
<ol class="loweralpha simple">
<li><p>[Bob] Send a request to open a channel with bob:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># [Bob]</span>
<span class="n">channel</span> <span class="n">send</span><span class="o">-</span><span class="n">opening</span><span class="o">-</span><span class="n">request</span> <span class="n">alice</span> <span class="mi">3</span> <span class="mi">4</span>
</pre></div>
</div>
<p>b. [Alice] Receives a channel opening request notification that includes
request ID. Reject it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># [Alice]</span>
<span class="n">channel</span> <span class="n">reject</span><span class="o">-</span><span class="n">opening</span><span class="o">-</span><span class="n">request</span> <span class="n">request_1_bob</span>
</pre></div>
</div>
<p>Once successfully accepted, information on the opened channel is printed in
both terminals.</p>
</li>
<li><p>Sending a payment on the open channel and accepting it.</p>
<ol class="loweralpha simple">
<li><p>[Alice] Send a payment to bob on an open channel:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># [Alice]</span>
<span class="n">payment</span> <span class="n">send</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">peer</span> <span class="n">ch_1_bob</span> <span class="mf">0.1</span>
</pre></div>
</div>
<ol class="loweralpha simple" start="2">
<li><p>[Bob] Receives a payment notification that includes the channel alias.
Accept it:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># [Bob]</span>
<span class="n">payment</span> <span class="n">accept</span><span class="o">-</span><span class="n">payment</span><span class="o">-</span><span class="n">update</span><span class="o">-</span><span class="n">from</span><span class="o">-</span><span class="n">peer</span> <span class="n">ch_1_alice</span>
</pre></div>
</div>
<p>Once payment is accepted, the updated information is printed on both
terminals.</p>
</li>
<li><p>Sending a payment on the open channel and rejecting it.</p>
<ol class="loweralpha simple">
<li><p>[Bob] Send a payment to bob on an open channel:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># [Bob]</span>
<span class="n">payment</span> <span class="n">send</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">peer</span> <span class="n">ch_1_alice</span> <span class="mf">0.2</span>
</pre></div>
</div>
<ol class="loweralpha simple" start="2">
<li><p>[Alice] Receives a payment notification that includes the channel alias.
Reject it:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># [Alice]</span>
<span class="n">payment</span> <span class="n">reject</span><span class="o">-</span><span class="n">payment</span><span class="o">-</span><span class="n">update</span><span class="o">-</span><span class="n">from</span><span class="o">-</span><span class="n">peer</span> <span class="n">ch_1_bob</span>
</pre></div>
</div>
<p>Once payment is rejected, green message is printed on alice terminal for
successfully rejecting the payment. Red error message is printed on bob
terminal as the payment was rejected by user.</p>
</li>
<li><p>Try to close the session will return error when there are open channels. Run
the below command in any or both of the terminals and they should return an
error.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span> <span class="n">close</span> <span class="n">no</span><span class="o">-</span><span class="n">force</span>
</pre></div>
</div>
<ol class="arabic simple" start="10">
<li><p>Close the channel.</p></li>
</ol>
<blockquote>
<div><ol class="loweralpha simple">
<li><p>[Alice] Close the channel with the below command.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># [Alice]</span>
<span class="n">channel</span> <span class="n">close</span><span class="o">-</span><span class="n">n</span><span class="o">-</span><span class="n">settle</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">chain</span> <span class="n">ch_1_bob</span>
</pre></div>
</div>
<ol class="loweralpha simple" start="2">
<li><p>[Bob] Receives a finalizing update when alice sends close command. This
is to finalize the channel off-chain, so that it can be collaboratively
closed on the blockchain without waiting for challenge duration to expire.
However, due to an issue (that will be fixed in next updated), the
collaborative close will not work as expected. So reject the finalizing
update:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># [Bob]</span>
<span class="n">payment</span> <span class="n">reject</span><span class="o">-</span><span class="n">payment</span><span class="o">-</span><span class="n">update</span><span class="o">-</span><span class="n">from</span><span class="o">-</span><span class="n">peer</span> <span class="n">ch_1_alice</span>
</pre></div>
</div>
</div></blockquote>
<p>Now the program will opt for non-collaborative close by registering the state
on the blockchain, waiting for the challenge duration to expire and then
withdrawing the funds.</p>
<p>Even if Bob doesn’t respond, Alice’s request will wait until response timeout
expires (in this demo it is 10s) and then proceed with non-collaborative close.
Bob’s node on the other hand will receive a notification when the channel is
finalized on the blockchain and funds will be withdrawn automatically. A
channel closed notification will be printed.</p>
<ol class="arabic simple" start="11">
<li><p>Close the session:</p></li>
</ol>
<p>Since the open channels are closed, the session can be closed with the same
command as in step 8, but without any error.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># [Alice]</span>
<span class="n">session</span> <span class="n">close</span> <span class="n">no</span><span class="o">-</span><span class="n">force</span>

<span class="c1"># [Bob]</span>
<span class="n">session</span> <span class="n">close</span> <span class="n">no</span><span class="o">-</span><span class="n">force</span>
</pre></div>
</div>
<ol class="arabic simple" start="12">
<li><p>To try out persistence of channels:</p></li>
</ol>
<blockquote>
<div><ol class="loweralpha simple">
<li><p>Open a session for alice, bob and then open a few channels using commands
described in step 4.</p></li>
<li><p>Close the session using force option:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># [Alice]</span>
<span class="n">session</span> <span class="n">close</span> <span class="n">force</span>

<span class="c1"># [Bob]</span>
<span class="n">session</span> <span class="n">close</span> <span class="n">force</span>
</pre></div>
</div>
<ol class="loweralpha simple" start="3">
<li><p>Open sessions for alice and bob again using the commands in step 3. Once
the session is opened, the channels restored from persistence will be printed
along with their aliases. You can send payments on these channels and close
them as before. There is no difference between a channel opened in current
session and a channel restored from persistence.</p></li>
</ol>
</div></blockquote>
<p>Remarks:</p>
<ol class="arabic simple">
<li><p>You can try to open as many channels as desired using the commands as
described in step 4. Each channel is addressed by its alias (that will be
suggested in auto-complete).</p></li>
<li><p>You can also try and send as many payments as desired using the commands as
described in step 7. However, whenever a new payment notification is
received, the previous one is automatically dropped. This however, is not a
feature of payment channel API, where you can respond to any of the
notifications as long as they have not expired. It was just a feature in the
perunnode-cli app to make it simpler.</p></li>
<li><p>The purpose of the perunnode-cli software is to demo the payment channel API
and also as a reference implementation for using the grpc client stubs.</p></li>
</ol>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        
        
        <a href="../concepts/state-channel.html" class="btn btn-neutral" title="Concepts" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
        
    </div>
    

    <hr/>

    <div role="contentinfo">
        <p>
        Copyright &copy; 2020 Hyperledger 
        <br>
        This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>&nbsp;&nbsp;<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="(CC-BY-4.0)" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>
        
        <span class="build">
            Build
            <a href="https://circleci.com/gh/hyperledger-labs/perun-doc/103">103</a>.
        </span>
        

        </p>
    </div>
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>